<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Questionnaire Drag & Drop Builder</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; background: #f2f5fa; }
        #palette, #builder, #renderer {
            border-radius: 12px;
            margin: 10px; padding: 12px; background: #fff;
            display: flex; flex-direction: column;
            border: 1px solid #e8eaf3;
        }
        #palette { flex: 0.8; min-width: 220px; max-width: 260px; }
        #builder { flex: 1.2; min-width: 320px; max-width: 540px;}
        #renderer { flex: 1; }
        h2 { font-size: 1.15em; font-weight: 600; margin-top: 0; margin-bottom: 10px; }
        .palette-list, #questionnaireList { min-height: 185px; padding: 10px; background: #f6f8fc; border-radius: 10px; border: 1px solid #e5eaf0; display: flex; flex-direction: column; }
        .palette-item {
            margin: 5px 0; padding: 9px 11px; background: #eef2fa;
            border-radius: 7px; border: 1px solid #cfd8ee;
            cursor: grab; font-size: 1em; display: flex; align-items: center; gap:7px;
        }
        .palette-item:hover { background: #d7e8ff; border-color: #88b1df;}
        .palette-icon { font-size: 1em; width: 22px; text-align:center; color:#007acc;}
        #questionnaireList { margin-bottom: 11px; }
        .question-item {
            border: 1px solid #dadeee;
            margin: 6px 0; padding: 9px; background: #fff;
            cursor: move; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,19,0.04);
            display: flex; align-items: flex-start; gap:8px; flex-direction: column;
        }
        .question-item-header {
            display: flex; align-items: center; gap: 8px; width: 100%;
        }
        .question-item.group { 
            background: #e8f4fd; 
            border-left: 5px solid #007acc; 
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .question-item.display { background: #f8f8f8; border-left: 4px solid #666; cursor: default; }
        
        /* Gruppierte Items - Einr√ºckung */
        .question-item.in-group { 
            margin-left: 25px; 
            background: #f9fbff;
            border-left: 3px solid #b3d9ff;
            position: relative;
        }
        .question-item.in-group:before {
            content: '';
            position: absolute;
            left: -28px;
            top: 15px;
            width: 20px;
            height: 2px;
            background: #b3d9ff;
        }
        .question-item.in-group:first-of-type:before {
            top: 15px;
            height: calc(100% - 15px);
            width: 2px;
            left: -15px;
            background: #b3d9ff;
        }
        
        .drag-over { background: #d0f0ff; border-color: #0099ff; }
        .type-specific { background:#f6f7fb; padding:8px; margin-top:8px; border-radius:7px; width: 100%;}
        textarea { width: 100%; height: 90px; font-family: monospace; font-size: 14px; border-radius: 4px; border:1px solid #e1e4ea;}
        input, select { padding: 5px; margin: 2px; border-radius: 4px; border:1px solid #dadeee;}
        button { padding: 8px 14px; margin: 3px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 4px; font-size:1em;}
        button:hover { background: #005999; }
        button.delete { background: #cc0000; padding: 6px 10px; }
        button.delete:hover { background: #aa0000; }
        #responseView { white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c; height: 120px; overflow-y: auto; font-family: monospace; border-radius:8px;}
        .input-field { width: 80%; padding: 5px; margin-right: 10px; }
        
        .group-indicator {
            font-size: 0.85em;
            color: #007acc;
            background: rgba(0, 122, 204, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: auto;
        }
    </style>
</head>
<body>

<div id="palette">
    <h2>Item-Typen</h2>
    <div class="palette-list">
        <div class="palette-item" draggable="true" data-type="group"><span class="palette-icon">üìÅ</span>Group (Gruppe)</div>
        <div class="palette-item" draggable="true" data-type="display"><span class="palette-icon">üí¨</span>Display (Anzeige)</div>
        <div class="palette-item" draggable="true" data-type="boolean"><span class="palette-icon">‚úîÔ∏è</span>Boolean</div>
        <div class="palette-item" draggable="true" data-type="decimal"><span class="palette-icon">üî¢</span>Decimal</div>
        <div class="palette-item" draggable="true" data-type="integer"><span class="palette-icon">üî¢</span>Integer</div>
        <div class="palette-item" draggable="true" data-type="date"><span class="palette-icon">üìÖ</span>Date</div>
        <div class="palette-item" draggable="true" data-type="dateTime"><span class="palette-icon">üìÖ</span>DateTime</div>
        <div class="palette-item" draggable="true" data-type="time"><span class="palette-icon">‚è∞</span>Time</div>
        <div class="palette-item" draggable="true" data-type="string"><span class="palette-icon">üìù</span>String</div>
        <div class="palette-item" draggable="true" data-type="text"><span class="palette-icon">‚úèÔ∏è</span>Text</div>
        <div class="palette-item" draggable="true" data-type="url"><span class="palette-icon">üîó</span>URL</div>
        <div class="palette-item" draggable="true" data-type="choice"><span class="palette-icon">‚¨õ</span>Choice</div>
        <div class="palette-item" draggable="true" data-type="open-choice"><span class="palette-icon">‚¨õ</span>Open-Choice</div>
        <div class="palette-item" draggable="true" data-type="attachment"><span class="palette-icon">üìé</span>Attachment</div>
        <div class="palette-item" draggable="true" data-type="reference"><span class="palette-icon">üë§</span>Reference</div>
        <div class="palette-item" draggable="true" data-type="quantity"><span class="palette-icon">üìè</span>Quantity</div>
    </div>
</div>

<div id="builder">
    <h2>Mein Fragebogen</h2>
    <div id="questionnaireList" ondragover="event.preventDefault();" ondrop="handleDrop(event)">
        <!-- Builder-Items erscheinen hier -->
    </div>
    <button onclick="exportQuestionnaire()">Questionnaire als JSON exportieren</button>
    <h3>Bestehendes Questionnaire JSON einf√ºgen</h3>
    <textarea id="loadQuestionnaireJson"></textarea>
    <button onclick="loadQuestionnaire()">Laden</button>
</div>

<div id="renderer">
    <h2>FHIR Questionnaire & Response Renderer</h2>
    <div id="questionnaireRender"></div>
    <button onclick="exportResponse()">Antwort als JSON exportieren</button>
    <h3>Questionnaire JSON einf√ºgen</h3>
    <textarea id="inputQuestionnaireJson"></textarea>
    <button onclick="renderQuestionnaire()">Rendern</button>
    <h3>Response JSON einf√ºgen</h3>
    <textarea id="inputResponseJson"></textarea>
    <button onclick="renderResponse()">Antworten anzeigen</button>
    <div id="responseView"></div>
</div>

<script>
const defaultTexts = {
    'group': 'Gruppe',
    'display': 'Anzeige-Text',
    'boolean': 'Ja/Nein Frage?',
    'decimal': 'Dezimalzahl eingeben',
    'integer': 'Ganze Zahl eingeben',
    'date': 'Datum ausw√§hlen',
    'dateTime': 'Datum und Zeit ausw√§hlen',
    'time': 'Zeit ausw√§hlen',
    'string': 'Text eingeben',
    'text': 'Mehrzeiliger Text',
    'url': 'URL eingeben',
    'choice': 'Option ausw√§hlen',
    'open-choice': 'Option ausw√§hlen oder Text eingeben',
    'attachment': 'Datei hochladen',
    'reference': 'Referenz ausw√§hlen',
    'quantity': 'Zahl mit Einheit'
};

let questions = [];
let itemIdCounter = 1;

// Palette Drag Start Handler
document.querySelectorAll('.palette-item').forEach(item => {
    item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/fhir-itemtype', item.getAttribute('data-type'));
    });
});

function handleDrop(event) {
    event.preventDefault();
    // Palette Item hinzugef√ºgt
    const type = event.dataTransfer.getData('text/fhir-itemtype');
    if (type) {
        // Pr√ºfen ob auf eine Gruppe gedroppt wird
        const targetGroup = event.target.closest('.question-item.group');
        if (targetGroup && type !== 'group') {
            const groupIndex = Array.from(document.querySelectorAll('.question-item')).indexOf(targetGroup);
            addQuestionToGroup(type, groupIndex);
        } else {
            addQuestionByType(type);
        }
        return;
    }
    
    // Builder-Reordering
    const fromIndex = parseInt(event.dataTransfer.getData('text/plain'), 10);
    const toElement = event.target.closest('.question-item');
    if (!toElement) return;
    const toIndex = Array.from(event.currentTarget.children).indexOf(toElement);
    if (toIndex < 0 || fromIndex === toIndex) return;
    const movedItem = questions.splice(fromIndex, 1)[0];
    questions.splice(toIndex, 0, movedItem);
    renderBuilderList();
}

function addQuestionByType(type) {
    const newQuestion = {
        linkId: 'item_' + (itemIdCounter++),
        text: defaultTexts[type] || 'Neue Frage',
        type: type,
    };
    if (type === 'choice' || type === 'open-choice') {
        newQuestion.answerOption = [];
    } else if (type === 'group') {
        newQuestion.item = [];
    }
    questions.push(newQuestion);
    renderBuilderList();
}

function addQuestionToGroup(type, groupIndex) {
    const newQuestion = {
        linkId: 'item_' + (itemIdCounter++),
        text: defaultTexts[type] || 'Neue Frage',
        type: type,
        parentGroup: groupIndex
    };
    if (type === 'choice' || type === 'open-choice') {
        newQuestion.answerOption = [];
    }
    
    // F√ºge zur Gruppe hinzu
    if (!questions[groupIndex].item) {
        questions[groupIndex].item = [];
    }
    questions[groupIndex].item.push(newQuestion);
    renderBuilderList();
}

function renderBuilderList() {
    const list = document.getElementById('questionnaireList');
    list.innerHTML = '';
    
    questions.forEach((q, index) => {
        // Hauptelement rendern
        const div = createQuestionElement(q, index, false);
        list.appendChild(div);
        
        // Wenn Gruppe: Sub-Items rendern
        if (q.type === 'group' && q.item && q.item.length > 0) {
            q.item.forEach((subItem, subIndex) => {
                const subDiv = createQuestionElement(subItem, `${index}-${subIndex}`, true, index);
                list.appendChild(subDiv);
            });
        }
    });
}

function createQuestionElement(q, index, isInGroup = false, parentIndex = null) {
    const div = document.createElement('div');
    div.className = 'question-item ' + q.type + (isInGroup ? ' in-group' : '');
    
    if (q.type !== 'display') {
        div.draggable = true;
        div.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', index.toString());
        };
    }
    
    const headerDiv = document.createElement('div');
    headerDiv.className = 'question-item-header';
    
    const icon = document.createElement('span');
    icon.style.cssText = 'color:#888;font-size:1.1em;';
    icon.textContent = getIcon(q.type);
    headerDiv.appendChild(icon);
    
    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.value = q.text;
    textInput.style.flex = '1';
    if (isInGroup) {
        textInput.onchange = (e) => updateGroupItemText(parentIndex, index.split('-')[1], e.target.value);
    } else {
        textInput.onchange = (e) => updateQuestionText(index, e.target.value);
    }
    headerDiv.appendChild(textInput);
    
    if (isInGroup) {
        const groupIndicator = document.createElement('span');
        groupIndicator.className = 'group-indicator';
        groupIndicator.textContent = 'in Gruppe';
        headerDiv.appendChild(groupIndicator);
    }
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete';
    deleteBtn.textContent = '√ó';
    if (isInGroup) {
        deleteBtn.onclick = () => removeGroupItem(parentIndex, index.split('-')[1]);
    } else {
        deleteBtn.onclick = () => removeQuestion(index);
    }
    headerDiv.appendChild(deleteBtn);
    
    div.appendChild(headerDiv);
    
    // Type-specific options
    const typeOptions = renderTypeSpecificOptions(index, q, isInGroup, parentIndex);
    if (typeOptions) {
        div.appendChild(typeOptions);
    }
    
    return div;
}

function getIcon(type) {
    switch (type) {
        case 'group': return 'üìÅ';
        case 'display': return 'üí¨';
        case 'boolean': return '‚úîÔ∏è';
        case 'decimal': case 'integer': return 'üî¢';
        case 'date': case 'dateTime': return 'üìÖ';
        case 'time': return '‚è∞';
        case 'string': return 'üìù';
        case 'text': return '‚úèÔ∏è';
        case 'url': return 'üîó';
        case 'choice': case 'open-choice': return '‚¨õ';
        case 'attachment': return 'üìé';
        case 'reference': return 'üë§';
        case 'quantity': return 'üìè';
        default: return '‚ùì';
    }
}

function renderTypeSpecificOptions(index, q, isInGroup = false, parentIndex = null) {
    let content = '';
    
    switch (q.type) {
        case 'choice':
        case 'open-choice':
            const choices = (q.answerOption || []).map(opt => opt.valueString || opt.valueCoding?.display || '').join(',');
            content = `
                <label>Optionen (kommasepariert):</label>
                <input type="text" class="choices-input" value="${choices}" 
                       onchange="${isInGroup ? `updateGroupItemChoices(${parentIndex}, ${index.split('-')[1]}, this.value)` : `updateChoices(${index}, this.value)`}" 
                       placeholder="Option1, Option2, Option3" style="width:100%;" />
            `;
            break;
        case 'quantity':
            content = `
                <label>Standard-Einheit:</label>
                <input type="text" value="${q.unit || ''}" 
                       onchange="${isInGroup ? `updateGroupItemUnit(${parentIndex}, ${index.split('-')[1]}, this.value)` : `updateUnit(${index}, this.value)`}" 
                       placeholder="kg, mg, cm, etc." style="width:100%;" />
            `;
            break;
        case 'reference':
            content = `
                <label>Referenz-Typ:</label>
                <input type="text" value="${q.referenceType || ''}" 
                       onchange="${isInGroup ? `updateGroupItemReferenceType(${parentIndex}, ${index.split('-')[1]}, this.value)` : `updateReferenceType(${index}, this.value)`}" 
                       placeholder="Patient, Practitioner, etc." style="width:100%;" />
            `;
            break;
        case 'attachment':
            content = `
                <label>Erlaubte Dateitypen:</label>
                <input type="text" value="${q.allowedTypes || ''}" 
                       onchange="${isInGroup ? `updateGroupItemAllowedTypes(${parentIndex}, ${index.split('-')[1]}, this.value)` : `updateAllowedTypes(${index}, this.value)`}" 
                       placeholder="image/*, .pdf, .docx" style="width:100%;" />
            `;
            break;
        default:
            return null;
    }
    
    if (content) {
        const div = document.createElement('div');
        div.className = 'type-specific';
        div.innerHTML = content;
        return div;
    }
    return null;
}

function updateQuestionText(index, value) {
    questions[index].text = value;
}

function updateGroupItemText(groupIndex, itemIndex, value) {
    questions[groupIndex].item[itemIndex].text = value;
}

function updateChoices(index, value) {
    const choices = value.split(',').map(s => s.trim()).filter(s => s);
    questions[index].answerOption = choices.map(choice => ({ valueString: choice }));
}

function updateGroupItemChoices(groupIndex, itemIndex, value) {
    const choices = value.split(',').map(s => s.trim()).filter(s => s);
    questions[groupIndex].item[itemIndex].answerOption = choices.map(choice => ({ valueString: choice }));
}

function updateUnit(index, value) {
    questions[index].unit = value;
}

function updateGroupItemUnit(groupIndex, itemIndex, value) {
    questions[groupIndex].item[itemIndex].unit = value;
}

function updateReferenceType(index, value) {
    questions[index].referenceType = value;
}

function updateGroupItemReferenceType(groupIndex, itemIndex, value) {
    questions[groupIndex].item[itemIndex].referenceType = value;
}

function updateAllowedTypes(index, value) {
    questions[index].allowedTypes = value;
}

function updateGroupItemAllowedTypes(groupIndex, itemIndex, value) {
    questions[groupIndex].item[itemIndex].allowedTypes = value;
}

function removeQuestion(index) {
    questions.splice(index, 1);
    renderBuilderList();
}

function removeGroupItem(groupIndex, itemIndex) {
    questions[groupIndex].item.splice(itemIndex, 1);
    renderBuilderList();
}

function exportQuestionnaire() {
    const questionnaire = {
        resourceType: "Questionnaire",
        id: "generated-questionnaire",
        status: "active",
        item: questions.map(mapToFhirItem)
    };
    const json = JSON.stringify(questionnaire, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        alert("FHIR Questionnaire JSON in Zwischenablage kopiert!");
    }).catch(() => {
        prompt("FHIR Questionnaire JSON", json);
    });
}

function mapToFhirItem(q) {
    const item = {
        linkId: q.linkId,
        type: q.type
    };
    item.text = q.text;
    if (q.answerOption && q.answerOption.length > 0) {
        item.answerOption = q.answerOption;
    }
    if (q.item && q.item.length > 0) {
        item.item = q.item.map(mapToFhirItem);
    }
    return item;
}

function loadQuestionnaire() {
    const input = document.getElementById('loadQuestionnaireJson').value;
    try {
        const parsed = JSON.parse(input);
        if (parsed.resourceType !== 'Questionnaire' || !Array.isArray(parsed.item)) {
            alert('Ung√ºltiges Questionnaire JSON');
            return;
        }
        questions = parsed.item.map(mapFromFhirItem);
        renderBuilderList();
    } catch (e) {
        alert('Fehler beim Parsen des JSON: ' + e.message);
    }
}

function mapFromFhirItem(fhirItem) {
    const item = {
        linkId: fhirItem.linkId,
        text: fhirItem.text || '',
        type: fhirItem.type
    };
    if (fhirItem.answerOption) {
        item.answerOption = fhirItem.answerOption;
    }
    if (fhirItem.item) {
        item.item = fhirItem.item.map(mapFromFhirItem);
    }
    return item;
}

// Renderer & Response (unver√§ndert)
let answerData = {};

function renderQuestionnaire() {
    const input = document.getElementById('inputQuestionnaireJson').value;
    try {
        const questionnaire = JSON.parse(input);
        if (questionnaire.resourceType !== 'Questionnaire' || !Array.isArray(questionnaire.item)) {
            alert('Ung√ºltiges Questionnaire JSON');
            return;
        }
        answerData = {};
        const container = document.getElementById('questionnaireRender');
        container.innerHTML = '';
        questionnaire.item.forEach(item => renderQuestionnaireItem(item, container));
    } catch (e) {
        alert('Fehler beim Rendern des Questionnaires: ' + e.message);
    }
}

function renderQuestionnaireItem(item, container) {
    const div = document.createElement('div');
    div.className = 'form-item ' + item.type;
    if (item.type === 'display') {
        div.innerHTML = `<div style="font-style: italic; color: #666;">${item.text}</div>`;
        container.appendChild(div);
        return;
    }
    if (item.type === 'group') {
        div.innerHTML = `<h3>${item.text}</h3>`;
        const nestedContainer = document.createElement('div');
        nestedContainer.className = 'nested-items';
        nestedContainer.style.marginLeft = '20px';
        nestedContainer.style.borderLeft = '2px solid #ccc';
        nestedContainer.style.paddingLeft = '10px';
        if (item.item) {
            item.item.forEach(nestedItem => renderQuestionnaireItem(nestedItem, nestedContainer));
        }
        div.appendChild(nestedContainer);
        container.appendChild(div);
        return;
    }
    const label = document.createElement('label');
    label.textContent = item.text || item.linkId;
    div.appendChild(label);

    let inputElem = createInputForType(item);
    if (inputElem) {
        div.appendChild(inputElem);
    }
    container.appendChild(div);
}

function createInputForType(item) {
    let inputElem;
    switch (item.type) {
        case 'boolean':
            inputElem = document.createElement('input');
            inputElem.type = 'checkbox';
            inputElem.onchange = (e) => answerData[item.linkId] = e.target.checked;
            break;
        case 'integer':
            inputElem = document.createElement('input');
            inputElem.type = 'number';
            inputElem.step = '1';
            inputElem.oninput = (e) => answerData[item.linkId] = parseInt(e.target.value) || 0;
            break;
        case 'decimal':
            inputElem = document.createElement('input');
            inputElem.type = 'number';
            inputElem.step = '0.01';
            inputElem.oninput = (e) => answerData[item.linkId] = parseFloat(e.target.value) || 0;
            break;
        case 'date':
            inputElem = document.createElement('input');
            inputElem.type = 'date';
            inputElem.onchange = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'dateTime':
            inputElem = document.createElement('input');
            inputElem.type = 'datetime-local';
            inputElem.onchange = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'time':
            inputElem = document.createElement('input');
            inputElem.type = 'time';
            inputElem.onchange = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'text':
            inputElem = document.createElement('textarea');
            inputElem.rows = 4;
            inputElem.oninput = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'url':
            inputElem = document.createElement('input');
            inputElem.type = 'url';
            inputElem.placeholder = 'https://example.com';
            inputElem.oninput = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'choice':
            inputElem = document.createElement('select');
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Bitte ausw√§hlen --';
            inputElem.appendChild(defaultOption);
            (item.answerOption || []).forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.valueString || opt.valueCoding?.code || '';
                option.textContent = opt.valueString || opt.valueCoding?.display || '';
                inputElem.appendChild(option);
            });
            inputElem.onchange = (e) => answerData[item.linkId] = e.target.value;
            break;
        case 'open-choice':
            const container = document.createElement('div');
            const selectElem = document.createElement('select');
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = '-- Ausw√§hlen oder anderen Text eingeben --';
            selectElem.appendChild(defaultOpt);
            (item.answerOption || []).forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.valueString || opt.valueCoding?.code || '';
                option.textContent = opt.valueString || opt.valueCoding?.display || '';
                selectElem.appendChild(option);
            });
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.placeholder = 'Oder eigenen Text eingeben...';
            textInput.style.marginTop = '5px';
            const updateAnswer = () => {
                answerData[item.linkId] = selectElem.value || textInput.value;
            };
            selectElem.onchange = updateAnswer;
            textInput.oninput = updateAnswer;
            container.appendChild(selectElem);
            container.appendChild(textInput);
            return container;
        case 'attachment':
            inputElem = document.createElement('input');
            inputElem.type = 'file';
            inputElem.onchange = (e) => {
                if (e.target.files[0]) {
                    answerData[item.linkId] = {
                        contentType: e.target.files[0].type,
                        title: e.target.files.name,
                        size: e.target.files.size
                    };
                }
            };
            break;
        case 'quantity':
            const quantityContainer = document.createElement('div');
            quantityContainer.style.display = 'flex';
            quantityContainer.style.gap = '10px';
            const valueInput = document.createElement('input');
            valueInput.type = 'number';
            valueInput.step = '0.01';
            valueInput.placeholder = 'Wert';
            const unitInput = document.createElement('input');
            unitInput.type = 'text';
            unitInput.placeholder = 'Einheit (kg, mg, cm...)';
            unitInput.style.width = '110px';
            const updateQuantity = () => {
                answerData[item.linkId] = {
                    value: parseFloat(valueInput.value) || 0,
                    unit: unitInput.value || ''
                };
            };
            valueInput.oninput = updateQuantity;
            unitInput.oninput = updateQuantity;
            quantityContainer.appendChild(valueInput);
            quantityContainer.appendChild(unitInput);
            return quantityContainer;
        case 'reference':
            inputElem = document.createElement('input');
            inputElem.type = 'text';
            inputElem.placeholder = 'Resource/ID (z.B. Patient/12345)';
            inputElem.oninput = (e) => answerData[item.linkId] = { reference: e.target.value };
            break;
        default:
            inputElem = document.createElement('input');
            inputElem.type = 'text';
            inputElem.oninput = (e) => answerData[item.linkId] = e.target.value;
    }
    if (inputElem) {
        inputElem.id = item.linkId;
        inputElem.style.width = '100%';
        inputElem.style.padding = '8px';
        inputElem.style.margin = '5px 0';
    }
    return inputElem;
}

function exportResponse() {
    const response = {
        resourceType: 'QuestionnaireResponse',
        status: 'completed',
        authored: new Date().toISOString(),
        item: []
    };
    
    // Flach alle Antworten sammeln
    function collectAnswers(items) {
        items.forEach(item => {
            if (item.item) {
                collectAnswers(item.item);
            }
        });
    }
    
    for (const linkId in answerData) {
        const answer = answerData[linkId];
        let answerObj = {};
        if (typeof answer === 'boolean') {
            answerObj = { valueBoolean: answer };
        } else if (typeof answer === 'number') {
            answerObj = { valueDecimal: answer };
        } else if (answer && typeof answer === 'object') {
            if (answer.value !== undefined && answer.unit !== undefined) {
                answerObj = { valueQuantity: answer };
            } else if (answer.reference) {
                answerObj = { valueReference: answer };
            } else {
                answerObj = { valueAttachment: answer };
            }
        } else {
            answerObj = { valueString: answer || '' };
        }
        if (answer !== '' && answer !== null && answer !== undefined) {
            response.item.push({ linkId: linkId, answer: [answerObj] });
        }
    }
    const json = JSON.stringify(response, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        alert("FHIR QuestionnaireResponse JSON in Zwischenablage kopiert!");
    }).catch(() => {
        prompt('FHIR QuestionnaireResponse JSON', json);
    });
}

function renderResponse() {
    const input = document.getElementById('inputResponseJson').value;
    try {
        const response = JSON.parse(input);
        if (response.resourceType !== 'QuestionnaireResponse' || !Array.isArray(response.item)) {
            alert('Ung√ºltiges QuestionnaireResponse JSON');
            return;
        }
        let output = `=== FHIR QuestionnaireResponse ===\n`;
        output += `Status: ${response.status}\n`;
        if (response.authored) {
            output += `Erstellt: ${new Date(response.authored).toLocaleString('de-DE')}\n`;
        }
        output += `\n=== Antworten ===\n`;
        response.item.forEach(item => {
            output += `\n${item.linkId}: `;
            if (item.answer && item.answer.length > 0) {
                const answer = item.answer[0];
                const answerKeys = Object.keys(answer);
                if (answerKeys.length > 0) {
                    const value = answer[answerKeys[0]];
                    if (typeof value === 'object') {
                        output += JSON.stringify(value, null, 2);
                    } else {
                        output += value;
                    }
                }
            } else {
                output += '(keine Antwort)';
            }
        });
        document.getElementById('responseView').textContent = output;
    } catch (e) {
        alert('Fehler beim Rendern der Antworten: ' + e.message);
    }
}

// Initialisiere mit leerem Builder
renderBuilderList();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Todo-Liste mit Prioritäten, Labels und Statistik</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    .todo { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .label {
      border-radius: 4px;
      padding: 2px 6px;
      margin-right: 5px;
      color: #fff;
      display: inline-block;
    }
    .priority {
      border-radius: 4px;
      padding: 2px 6px;
      margin-right: 5px;
      font-weight: bold;
      display: inline-block;
    }
    .priority.hoch { background: #e53935; color: #fff; }
    .priority.mittel { background: #fbc02d; color: #fff; }
    .priority.niedrig { background: #43a047; color: #fff; }
    .stats { margin-top: 20px; }
    .running { color: green; }
    .stopped { color: red; }
    .done-btn {
      margin-left: 10px;
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 8px;
    }
    .label-delete-btn {
      margin-left: 5px;
      background: #fff;
      color: #333;
      border: 1px solid #888;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      padding: 0 4px;
    }
    .add-time-form input {
      width: 40px;
      margin-right: 2px;
    }
    .add-time-form button {
      margin-right: 2px;
    }
  </style>
</head>
<body>
  <h2>Todo-Liste mit Prioritäten, Labels und Statistik</h2>
  <form id="todoForm">
    <input type="text" id="todoText" placeholder="Todo" required>
    <select id="todoLabelSelect">
      <option value="">Label auswählen</option>
    </select>
    <button type="button" id="deleteLabelBtn" title="Ausgewähltes Label löschen">Label löschen</button>
    <input type="text" id="todoLabelInput" placeholder="Neues Label (optional)">
    <select id="todoPrioritySelect">
      <option value="hoch">Hoch</option>
      <option value="mittel" selected>Mittel</option>
      <option value="niedrig">Niedrig</option>
    </select>
    <button type="submit">Hinzufügen</button>
  </form>

  <div style="margin: 10px 0;">
    <input type="text" id="newLabelInput" placeholder="Neues Label erstellen">
    <button type="button" id="createLabelBtn">Label erstellen</button>
  </div>

  <div id="todoList"></div>

  <div class="stats">
    <h3>Statistiken</h3>
    <div id="totalTime"></div>
    <div id="labelTimes"></div>
    <div>
      <h4>Auslastung berechnen</h4>
      <label>Verfügbare Arbeitszeit (Stunden/Monat): 
        <input type="number" id="workHours" value="160">
      </label>
      <button onclick="calculateUtilization()">Berechnen</button>
      <div id="utilization"></div>
    </div>
    <div>
      <h4>Monatsstatistik</h4>
      <div id="monthlyStats"></div>
    </div>
  </div>

  <script>
    function randomColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue},70%,50%)`;
    }

    function saveLabels() {
      localStorage.setItem('labels', JSON.stringify(labels));
    }
    function loadLabels() {
      try {
        return JSON.parse(localStorage.getItem('labels')) || [];
      } catch {
        return [];
      }
    }
    function saveTodos() {
      localStorage.setItem('todos', JSON.stringify(todos));
    }
    function loadTodos() {
      try {
        return JSON.parse(localStorage.getItem('todos')) || [];
      } catch {
        return [];
      }
    }
    function saveDoneTodos() {
      localStorage.setItem('doneTodos', JSON.stringify(doneTodos));
    }
    function loadDoneTodos() {
      try {
        return JSON.parse(localStorage.getItem('doneTodos')) || [];
      } catch {
        return [];
      }
    }

    let labels = loadLabels();
    let todos = loadTodos();
    let doneTodos = loadDoneTodos();
    let timerIntervals = {};

    function updateLabelSelect() {
      const select = document.getElementById('todoLabelSelect');
      select.innerHTML = '<option value="">Label auswählen</option>';
      labels.forEach(label => {
        const opt = document.createElement('option');
        opt.value = label.name;
        opt.textContent = label.name;
        opt.style.backgroundColor = label.color;
        opt.style.color = "#fff";
        select.appendChild(opt);
      });
    }

    function getLabelColor(labelName) {
      const label = labels.find(l => l.name === labelName);
      return label ? label.color : '#888';
    }

    function formatTime(ms) {
      let sec = Math.floor(ms / 1000) % 60;
      let min = Math.floor(ms / 60000) % 60;
      let h = Math.floor(ms / 3600000);
      return `${h}h ${min}m ${sec}s`;
    }

    function renderTodos() {
      const list = document.getElementById('todoList');
      list.innerHTML = '';
      // Sortierte Kopie für Anzeige, aber Index im Original merken!
      const prioOrder = { hoch: 1, mittel: 2, niedrig: 3 };
      const sorted = todos
        .map((todo, idx) => ({ ...todo, origIdx: idx }))
        .sort((a, b) => prioOrder[a.priority] - prioOrder[b.priority]);

      sorted.forEach(todo => {
        const idx = todo.origIdx;
        const div = document.createElement('div');
        div.className = 'todo';
        div.innerHTML = `
          <strong>${todo.text}</strong>
          ${todo.label ? `<span class="label" style="background:${getLabelColor(todo.label)}">${todo.label}</span>` : ''}
          <span class="priority ${todo.priority}">${todo.priority.charAt(0).toUpperCase() + todo.priority.slice(1)}</span>
          <div>
            Zeit: <span id="time-${idx}">${formatTime(todo.time)}</span>
            <button onclick="toggleTimer(${idx})" id="btn-${idx}">${todo.running ? 'Stoppen' : 'Starten'}</button>
            <button onclick="deleteTodo(${idx})">Löschen</button>
            <button class="done-btn" onclick="markDone(${idx})">Erledigt</button>
            <button onclick="showAddTimeForm(${idx})">Zeit hinzufügen</button>
            <span id="addTimeForm-${idx}" class="add-time-form" style="display:none;">
              <input type="number" id="addH-${idx}" min="0" placeholder="h">
              <input type="number" id="addM-${idx}" min="0" max="59" placeholder="m">
              <input type="number" id="addS-${idx}" min="0" max="59" placeholder="s">
              <button onclick="addManualTime(${idx})" type="button">OK</button>
              <button onclick="hideAddTimeForm(${idx})" type="button">Abbrechen</button>
            </span>
            <span class="${todo.running ? 'running' : 'stopped'}">${todo.running ? 'läuft...' : ''}</span>
          </div>
        `;
        list.appendChild(div);
      });
      updateStats();
    }

    function showAddTimeForm(idx) {
      document.getElementById(`addTimeForm-${idx}`).style.display = 'inline';
    }
    function hideAddTimeForm(idx) {
      document.getElementById(`addTimeForm-${idx}`).style.display = 'none';
    }
    function addManualTime(idx) {
      const h = parseInt(document.getElementById(`addH-${idx}`).value) || 0;
      const m = parseInt(document.getElementById(`addM-${idx}`).value) || 0;
      const s = parseInt(document.getElementById(`addS-${idx}`).value) || 0;
      const addMs = ((h * 60 * 60) + (m * 60) + s) * 1000;
      todos[idx].time += addMs;
      saveTodos();
      hideAddTimeForm(idx);
      renderTodos();
    }

    function updateStats() {
      let total = [...todos, ...doneTodos].reduce((sum, t) => sum + t.time, 0);
      document.getElementById('totalTime').innerText = `Gesamtzeit: ${formatTime(total)}`;

      let labelMap = {};
      [...todos, ...doneTodos].forEach(t => {
        if (t.label) {
          if (!labelMap[t.label]) labelMap[t.label] = 0;
          labelMap[t.label] += t.time;
        }
      });
      let labelHtml = '<ul>';
      for (let label in labelMap) {
        labelHtml += `<li><span class="label" style="background:${getLabelColor(label)}">${label}</span>: ${formatTime(labelMap[label])}</li>`;
      }
      labelHtml += '</ul>';
      document.getElementById('labelTimes').innerHTML = labelHtml;

      updateMonthlyStats();
    }

    function addTodo(text, label, priority) {
      todos.push({ text, label, priority, time: 0, running: false, start: null });
      saveTodos();
      renderTodos();
    }

    function deleteTodo(idx) {
      stopTimer(idx);
      todos.splice(idx, 1);
      saveTodos();
      renderTodos();
    }

    function toggleTimer(idx) {
      if (todos[idx].running) {
        stopTimer(idx);
      } else {
        startTimer(idx);
      }
      renderTodos();
    }

    function startTimer(idx) {
      if (todos[idx].running) return;
      todos[idx].running = true;
      todos[idx].start = Date.now();
      timerIntervals[idx] = setInterval(() => {
        let now = Date.now();
        todos[idx].time += now - todos[idx].start;
        todos[idx].start = now;
        document.getElementById(`time-${idx}`).innerText = formatTime(todos[idx].time);
        saveTodos();
        updateStats();
      }, 1000);
      saveTodos();
    }

    function stopTimer(idx) {
      if (!todos[idx].running) return;
      todos[idx].running = false;
      let now = Date.now();
      todos[idx].time += now - todos[idx].start;
      todos[idx].start = null;
      clearInterval(timerIntervals[idx]);
      saveTodos();
      updateStats();
    }

    function markDone(idx) {
      stopTimer(idx);
      let today = new Date();
      let doneDate = today.toISOString().slice(0, 10);
      let todo = todos[idx];
      todo.doneDate = doneDate;
      doneTodos.push(todo);
      saveDoneTodos();
      todos.splice(idx, 1);
      saveTodos();
      renderTodos();
    }

    function calculateUtilization() {
      let hours = parseFloat(document.getElementById('workHours').value) || 0;
      let total = [...todos, ...doneTodos].reduce((sum, t) => sum + t.time, 0) / 3600000;
      let percent = hours ? ((total / hours) * 100).toFixed(1) : 0;
      document.getElementById('utilization').innerText = `Auslastung: ${percent}% (${total.toFixed(2)}h von ${hours}h)`;
    }

    function addNewLabel(labelName) {
      if (!labelName || labels.find(l => l.name === labelName)) return;
      const color = randomColor();
      labels.push({ name: labelName, color });
      saveLabels();
      updateLabelSelect();
    }

    function deleteSelectedLabel() {
      const select = document.getElementById('todoLabelSelect');
      const selectedValue = select.value;
      if (!selectedValue) return;
      if (!confirm(`Label "${selectedValue}" wirklich löschen?`)) return;
      labels = labels.filter(l => l.name !== selectedValue);
      saveLabels();
      updateLabelSelect();
      select.selectedIndex = 0;
    }

    function updateMonthlyStats() {
      const workHours = parseFloat(document.getElementById('workHours').value) || 0;
      let monthlyMap = {};
      doneTodos.forEach(todo => {
        if (todo.doneDate) {
          let month = todo.doneDate.slice(0, 7);
          if (!monthlyMap[month]) monthlyMap[month] = 0;
          monthlyMap[month] += todo.time;
        }
      });
      let now = new Date();
      let thisMonth = now.toISOString().slice(0, 7);
      let openTime = todos.reduce((sum, t) => sum + t.time, 0);
      if (!monthlyMap[thisMonth]) monthlyMap[thisMonth] = 0;
      monthlyMap[thisMonth] += openTime;

      let html = '<table border="1" cellpadding="4"><tr><th>Monat</th><th>Gesamtzeit</th><th>Auslastung</th></tr>';
      Object.keys(monthlyMap).sort().reverse().forEach(month => {
        let hours = monthlyMap[month] / 3600000;
        let percent = workHours ? ((hours / workHours) * 100).toFixed(1) : 0;
        html += `<tr><td>${month}</td><td>${formatTime(monthlyMap[month])}</td><td>${percent}%</td></tr>`;
      });
      html += '</table>';
      document.getElementById('monthlyStats').innerHTML = html;
    }

    document.getElementById('todoForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const text = document.getElementById('todoText').value.trim();
      let label = document.getElementById('todoLabelInput').value.trim();
      const priority = document.getElementById('todoPrioritySelect').value;
      if (!label) label = document.getElementById('todoLabelSelect').value;
      if (label && !labels.find(l => l.name === label)) {
        addNewLabel(label);
      }
      if (text) addTodo(text, label, priority);
      document.getElementById('todoText').value = '';
      document.getElementById('todoLabelInput').value = '';
      document.getElementById('todoLabelSelect').selectedIndex = 0;
      document.getElementById('todoPrioritySelect').value = 'mittel';
    });

    document.getElementById('deleteLabelBtn').addEventListener('click', deleteSelectedLabel);

    document.getElementById('createLabelBtn').addEventListener('click', function() {
      const labelName = document.getElementById('newLabelInput').value.trim();
      if (labelName && !labels.find(l => l.name === labelName)) {
        addNewLabel(labelName);
        document.getElementById('newLabelInput').value = '';
      }
    });

    // Initial rendering
    updateLabelSelect();
    renderTodos();
  </script>
</body>
</html>
